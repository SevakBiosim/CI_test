name: Test (comment /test or manual)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number to test"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: read
  statuses: write

concurrency:
  group: test-command-${{ github.repository }}-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  test:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '/test'))
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR + head SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber =
              context.eventName === "workflow_dispatch"
                ? Number(context.payload.inputs.pr_number)
                : context.payload.issue.number;

            if (!prNumber) {
              core.setFailed("No pr_number provided for workflow_dispatch.");
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            core.setOutput("pr_number", String(prNumber));
            core.setOutput("head_sha", pr.head.sha);
            core.setOutput("head_ref", pr.head.ref);
            core.setOutput("head_repo_full_name", pr.head.repo.full_name);

      - name: Set required status to pending (shows as running/waiting)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = "${{ steps.pr.outputs.head_sha }}";

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: "pending",
              context: "test-command",
              description: "Tests are runningâ€¦",
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.head_repo_full_name }}
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Run tests
        run: |
          echo "Running tests for PR #${{ steps.pr.outputs.pr_number }} @ ${{ steps.pr.outputs.head_sha }}"
          sleep 15

      - name: Set status to success/failure on the PR head SHA
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = "${{ steps.pr.outputs.head_sha }}";

            const ok = "${{ job.status }}" === "success";
            const state = ok ? "success" : "failure";
            const description = ok ? "Tests passed" : "Tests failed";

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state,
              context: "test-command",
              description,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
